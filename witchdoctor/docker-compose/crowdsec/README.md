# Crowdsec installation for distributed multi-server setup using containers <!-- omit from toc -->

- [1. Overview](#1-overview)
  - [1.1. Definitions and terminology](#11-definitions-and-terminology)
- [2. Configuration steps and pre-requirements](#2-configuration-steps-and-pre-requirements)
  - [2.1. Install and configure CrowdSec Plugin on the Firewall (OPNsense)](#21-install-and-configure-crowdsec-plugin-on-the-firewall-opnsense)
  - [2.2. On CrowdSec Portal: Create a CrowdSec Account Login.](#22-on-crowdsec-portal-create-a-crowdsec-account-login)
  - [2.3. On  the LAPI: Enroll the LAPI with the CAPI](#23-on--the-lapi-enroll-the-lapi-with-the-capi)
  - [2.4. On the secondary server: Most important configuration to check for the new log processor](#24-on-the-secondary-server-most-important-configuration-to-check-for-the-new-log-processor)
  - [2.5. On the secondary server: Initial start of the log processor container and LAPI registration](#25-on-the-secondary-server-initial-start-of-the-log-processor-container-and-lapi-registration)
  - [2.6. On  the LAPI: Validate the registration of the log processor](#26-on--the-lapi-validate-the-registration-of-the-log-processor)
  - [2.7. On the secondary server: Final changes to the container configuration](#27-on-the-secondary-server-final-changes-to-the-container-configuration)
  - [2.8. On the LAPI: Validate that is everything working](#28-on-the-lapi-validate-that-is-everything-working)
- [3. Troubleshooting](#3-troubleshooting)
  - [3.1. Fixing bad machine name registration on the LAPI](#31-fixing-bad-machine-name-registration-on-the-lapi)
  - [3.2. Issues setting an AGENT\_PASSWORD](#32-issues-setting-an-agent_password)
- [4. Improvement and additional reading](#4-improvement-and-additional-reading)

> [!WARNING] 
> This guide assumes general knowledge about using `docker` and `docker compose`. 
> The correct root (`sudo`) and rootless commands might not always be provide, or could be use interchangeble or inconsistantly in this guide. 
> Adapt as needed according to your environment.

# 1. Overview
Using official CrowdSec guides and blog[^crowdsec_doc_mutltiserver] [^crowdsec_blog_mutltiserver_tutorial] [^crowdsec_blog_compose_treafik] [^crowdsec_youtube_multiserver] [^crowdsec_blog_opnsense], this is a guide on how we installed and configured a distributed CrowdSec setup. For a simpliet single/isolated CrowdSec installation, refer to the official [CrowdSec Installation documentation](https://docs.crowdsec.net/u/getting_started/intro) rather.

For the distribted setup that was chosen, the main CrowdSec installation and local API is installed on firewall. The local CrowdSec installation on the servers ingress the logs from the local service, container, or system. 

Current implemented log sources are:
 - Traefik access log
 - Vaultwarden access logs (to be implemented)
  

> [!TIP] 
> Application/server log pasers and scenarios, (and profiles??) need to be installed on the log processor, and not on the LAPI. The LAPI generates the `decisions` based on the output from the log processors. The remediation components implement the `decisions` coming from the LAPI. The remediation components can be on the same system as the log processor or not.




##  1.1. Definitions and terminology

- Bouncer: Obsolete, but still in used in documentation and API commands. Renamed and refer to 'Remediation Component'
- CAPI: Central API. The main CrowdSec servers/portal. Receives community reports about suspicious IPs and activities. Evaluates and complies block lists (free and paid), that are used by the LAPI in scenario and `decisions`.
- csli: The crowdsec command line tool to interact or inspect the various local crowdsec component. Can be access via `docker exec` or SSH into the firewall.
- LAPI: Local API. The local CrowdSec Security Engine. Processes `alters` generated by log processors by evaluating these against scenarios, to detect specific types of attacks or suspicious patterns. Transforms  `alerts` into `decision` which need to be then `remediated`, i.e. blocked the connection / traffic.
- Log processors: Parses logs and creates `alerts`. That are sent to the LAPI for further evaluation.
- Remediation Component[^crowdsec_guide_bouncer] [^crowdsec_docs_remediation]: Software packages or plugins that connect to the LAPI to retreive `decision` and implement the actual `remediations` actions. These componets can be:
  - Firewall remediation: ip block rules
  - Loadbalance / Proxy remediation: Embedded implementation or plugin wihin an exisisting application, i.e. Traefik, Nginx, etc.
  - Official list [CrowdSec - Remediation Components](https://app.crowdsec.net/hub/remediation-components)
  

# 2. Configuration steps and pre-requirements

##  2.1. Install and configure CrowdSec Plugin on the Firewall (OPNsense)
1) Read the instructions in the CrowdSec Plugin for configuration changes that need to be made.
2) The following changes were made to our CrowdSec Plugin WebUI:
   1) Enable all options, except `Verbose log`
   2) `Manual LAPI configuration`, to allow for additional servers to be added to the LAPI (distributed setup), and prevent the config files being overritten
   3) Configure `LAPI listen address` and `LAPI listen port` to the IP address of the Firewall and an available port e.g. `8081`. The IP cannot be `127 0.0.1` for multi server setups.
   4) Create a firewall rule to allow the IPs or subnet of remediation component to access the firewall on the `LAPI PORT`.

##  2.2. On CrowdSec Portal: Create a [CrowdSec Account Login](https://app.crowdsec.net/sign-in).
1) (Optional) Configure the account settings.
2) Create an enroll request for the LAPI installation by clicking the `Enroll command` button on [CrowdSec - Security Engine](https://app.crowdsec.net/security-engines) page. The output will provide the command to be execute on the LAPI. It will contain an `<ENROLL_TOKEN>` that is unique to your CrowdSec Account (CAPI) and look as follows:
   ```console
   ## Example of the enroll command that will be displayed in the CrowdSec portal
   sudo  cscli console enroll -e context <ENROLL_TOKEN>
   ```

##  2.3. On  the LAPI: Enroll the LAPI with the CAPI
> [!NOTE] 
> The CrowdSec plugin does not provide the `enroll` function within firewall WebUI (OPNsense). This needs to be performed directly at the command line or via SSH.

1) SSH into the firewall (OPNsense)
2) Check if CrowdSec is installed using: 
   ```console
   ## Test if crowdsec is installed and what version
   sudo cscli version
   ```
3) Using the output from the previous step, enroll the LAPI with CAPI:
   ```console
   ## Enroll command to be run on the LAPI
   sudo  cscli console enroll -e  context <ENROLL_TOKEN>
   ```
4) (Optional) Configuring auto-registration of log processors is possible but _not_ recommended: [CrowdSec Guides - Auto-register log Processor](https://docs.crowdsec.net/u/user_guides/multiserver_setup/#lapi)

##  2.4. On the secondary server: Most important configuration to check for the new log processor
> [!NOTE] 
> This guide only consisders creating the new crowdsec log processor as a container. Installing CrowdSec directly on the system is possible but not covered here.
1) Check container environment setup variables in [.env](.env). Important variables are:
   1) `IMAGE_TAG`: CrowdSec container image tage to use. 
   2) `CONTAINER_CONFIG`: Where to store the persistant data for CrowdSec.
2) Check CrowdSec configuration setting in [.env.crowdsec](.env.crowdsec). Important variables are:
   1) `DISABLE_LOCAL_API="false"`: Only needed for first startup, else the container fails to start.[^Multiserver_FailStart]
   2) `LAPI_HOST_URL`: Change to the same IP:Port define in the firewall (OPNsense) plugin. Format: `http://IP:PORT`.
   3) `COLLECTIONS`: Define the collections that will be monitored on this system. List of official [collections](https://app.crowdsec.net/hub/collections) available.
3) (Optional) Add bind mounts for additional log sources to be monitored to the [compose.yaml](compose.yaml) file.

##  2.5. On the secondary server: Initial start of the log processor container and LAPI registration 
1) Start the new log processor container with:
   ```console
   ## Start the CrowdSec container
   docker compose up -d
   ```
2) Register the log processor to the LAPI with:
   ``` Console
   ## Run the one of the following commands to register the log processor with the LAPI

   ## For Docker installation
   sudo docker exec -it crowdsec sh -c 'cscli lapi register --machine "$REGISTER_USERNAME" --url "$LAPI_HOST_URL"'
   
   ## For Docker-rootless installation
   docker exec -it crowdsec sh -c 'cscli lapi register --machine "$REGISTER_USERNAME" --url "$LAPI_HOST_URL"'
   ```
   If there are no errors, the output will be:
   ![Successful registration with LAPI](<../../../Assets/Crowdsec - Multiserver setup - Successful registration.png>)

##  2.6. On  the LAPI: Validate the registration of the log processor
1) SSH into the firewall (OPNsense) 
2) Run the following command to see any pending registration/s:
   ```console
   ## Display pending registration and registered machines
   sudo cscli machine list
   ```
3) Accept the registration with:
   ```console
   ## Accept the registration. Change the placeholder <MACHINE-NAME> ## with 
   ## Name from the previous setp (i.e REGISTER_USERNAME) 
   sudo cscli machines validate "<MACHINE-NAME>"
   ```
4) (Optional) Create a bouncer API Token. Only required if a remediation component (bouncer) will be running _**next to**_ the CrowdSec container. The CrowdSec container does not any perform remediation[^crowdsec_guide_bouncer].
   ```console
   ## Create a bouncer API Token. The placeholder <BOUNCER_NAME> can be defined as anything string.
   ## Using a define naming scheme makes future maintainance easier and to distinguish API token types:
   ## e.g. [HOST/IP]_[REMEDITION_SERVICE]_bouncer; [HOST/IP]_crowdsec_processor
   sudo cscli bouncers add <BOUNCER_NAME>
   ```
   If there are no errors, the output will be as follows. 
   ![Creation of bouncer API Token on LAPI](<../../../Assets/Crowdsec - Multiserver setup - Creating new bouncer API token.png>)
   Copy the key into the required docker secrets file.
   
##  2.7. On the secondary server: Final changes to the container configuration 
   1) Stop the running container with:
   ```console
   ## Stop the container
   docker compose down
   ```
   2) The following modification can be made to the [.env.crowdsec](.env.crowdsec) file, as they are now stored in the container's persistant storage, or not required anymore for future container starts.
   ```diff
   -REGISTER_USERNAME="${HOSTNAME:?}_crowdsec"
   -LAPI_HOST_URL="http://10.0.31.1:8081"

   -DISABLE_LOCAL_API="false"
   +DISABLE_LOCAL_API="true"

   + ## If, in the future, additional logs for processing, additional collections might need to be defined here
   COLLECTIONS="crowdsecurity/traefik crowdsecurity/http-cve"
   ```
   3) Restart the log processor container with:
   ```console
   ## Start the container
   docker compose up -d
   ```

##  2.8. On the LAPI: Validate that is everything working
1) SSH into the firewall (OPNsense) 
2) Run the following command to see connection status:
   ```console
   ## Display pending registration and registered machines
   sudo cscli machine list
   ```
   In the output look at the `Last Heartbeat`; values above 2 minutes are marked as unhealth. Multi-minute or hour values indicate configuration errors or connection issues, and need to be investigate.
   ![Checking connection issues on the LAPI](<../../../Assets/Crowdsec - Multiserver setup - Connection diagnostic check.png>)
3) (Optional) Additional metrics, such as `alerts`, `decisions`, `scenarios`, etc. can be check on the LAPI, but is beyond the scope of this guide. Refer to CrowdSec Portal or [cscli documentation](https://docs.crowdsec.net/docs/cscli/) for more information. A few useful commands are:
   ```console
   ## Show alerts that were generated
   sudo cscli alerts list

   ## Show current decision which are in effect
   sudo cscli decisions list

   ## Add a block decision against specific IP. Careful to not block yourself!
   sudo cscli decisions add --ip x.x.x.x
   ```

# 3. Troubleshooting

##  3.1. Fixing bad machine name registration on the LAPI

During testing the of `docker exec` and `cscli` commands to perform machine registration with the real LAPI, the `--url` flag was used as the machine name instead of the value stored in the environment variable. 

:x: It was **not** possible to remove these registration on the LAPI using any of the following commands:
```console
## Using various formats of quotes or backticks proved unsuccessful
sudo cscli machine delete --url
sudo cscli machine delete '--url'
sudo cscli machine delete "--url"
sudo cscli machine delete `--url`
```
:white_check_mark: This issue could only be resolved with:
```console
sudo cscli machine prune
```
which listed and then removed any unvalidated registration requests.

##  3.2. Issues setting an AGENT_PASSWORD

CrowdSec requires a minimum 32 character string for `AGENT_PASSWORD` variable when registering a log processor.

:x: Two issues were discovered:
1) While the CrowdSec documentation state that docker secrets can be used[^crowdsec_docs_docker_install] [^docker_hub_crowdsec], we were not able to get this to work successfull. Perhaps this is only be applicable to remediation API tokens (bouncer keys).
2) Using randomly generated passwords and assign the value to `AGENT_PASSWORD` was a problem, if the password contained any `$` characters. Different methods of quote and backticks were tried to resolve this. But due to variable expansion by the shell, the `$` was either shallowed or additional escape character were included.

:white_check_mark: The resoution was simple: _**not**_ providng a password.  When `cscli` was used to register the machine with the LAPI,  and the the password option was skipped on not supplied, results in:
1) `cscli` automatically generating a random password, that meets the length requirements.
2) `cscli` will automatically stores the credentials (`AGENT_USERNAME` & `AGENT_PASSWORD`) in a `/etc/crowdsec/local_api_credentials.yaml` file, within the container persistant storage.
3) This removes the need to store any `AGENT_XXX` values in the `compose.yaml`, `.env`, or `.env.crowdsec` files. 

The only scenarios to still include these credentials in the config files, would be:
   1) If the container needs to be or is migrated, _**and**_ the persistant storage data **_cannot_** be migrate as well. This is a strange techincal limitation that should be resolved first.
   2) If multiple containers need to use the same agent credential. While this is feasible, it make token management much harder, and has obvious secuirty issues of including this type of information in the config files. 




# 4. Improvement and additional reading

1) Securing communication using HTTPS
   1) [Secure a multiserver installation with HTTPS](https://www.crowdsec.net/blog/secure-a-multi-server-installation-with-https) 
   2) [Crowdsec Docs - TLS Auth](https://docs.crowdsec.net/docs/next/local_api/tls_auth)
   3) Investigate possibility of using CertWarden to handle co-ordination of new LetsEncrypt certificates.
2) [Using docker labels for service discovery](https://github.com/crowdsecurity/example-docker-compose/blob/main/container-labels/README.md)
3) CrowdSec Blocklist and Catalogs
   1) [Crowdsec Blog - Blocklist & Catalogs](https://www.crowdsec.net/blog/new-blocklist-catalog)
   2) [Crowdsec - Free thrid party blocklists](https://www.crowdsec.net/blog/discover-crowdsecs-free-third-party-blocklists)
4) Ingetration with a XDR or SIEM solution:
   1) [Crowdsec Blog - Waste attacker resources](https://www.crowdsec.net/blog/waste-attacker-resources)
   2) [Suricata](https://www.crowdsec.net/blog/crowdsec-and-suricata-integration)
   3) [Wazuh](https://www.crowdsec.net/blog/improving-observability-crowdsec-and-wazuh-integration)
5) [Protecting against DDoS attacks with CrowdSec and Traefik](https://www.crowdsec.net/blog/protect-tcp-udp-ports-against-ddos-attacks).
6) [Crowdsec Blog - Waste attacker resources](https://www.crowdsec.net/blog/waste-attacker-resources)


<!-- Add all Footnote References used in document here to prevent cluster -->
[^crowdsec_doc_mutltiserver]: [CrowdSec - Multi server setup](https://docs.crowdsec.net/u/user_guides/multiserver_setup/)
[^crowdsec_blog_mutltiserver_tutorial]: [CrowdSec Blog - Multi server tutorial](https://www.crowdsec.net/blog/multi-server-setup)
[^crowdsec_blog_compose_treafik]: [CrowdSec Blog - Docker Compose Security with CrowdSec and Traefik](https://www.crowdsec.net/blog/enhance-docker-compose-security)
[^crowdsec_youtube_multiserver]: [Youtube - CrowdSec Workshop - Multi server installtion](https://www.youtube.com/watch?v=V4rr2gcPfW0)
[^crowdsec_blog_opnsense]: [CrowdSec Blog - OPNsense](https://www.crowdsec.net/blog/crowdsec-arrives-on-opnsense)
[^Multiserver_FailStart]: [The Homelabber - Configuring multi-server Crowdsec](https://thehomelabber.com/guides/crowdsec-multi-server/)
[^crowdsec_docs_remediation]: [CrowdSec - Remediation Components](https://docs.crowdsec.net/u/bouncers/intro/)
[^crowdsec_guide_bouncer]: [CrowdSec Guide - Bouncer](https://docs.crowdsec.net/u/user_guides/bouncers_configuration/)
[^docker_hub_crowdsec]:[Docker Hub - CrowdSec](https://hub.docker.com/r/crowdsecurity/crowdsec)
[^crowdsec_docs_docker_install]:[CrowdSec - Docker Installation](https://docs.crowdsec.net/u/getting_started/installation/docker/)

[^crowdsec_docs_cscli]: [CrowdSec Documents - cscli](https://docs.crowdsec.net/docs/cscli/)